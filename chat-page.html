<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat with Mas Agus</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom styles for chat bubbles and loading spinner */
      .chat-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 20px;
        margin-bottom: 10px;
      }

      .loading-spinner {
        border-top: 4px solid transparent;
        border-radius: 50%;
        border: 4px solid #f3f3f3;
        border-top-color: #3498db;
        width: 25px;
        height: 25px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body class="bg-gray-50 font-sans">
    <div class="container mx-auto p-6">
      <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <div id="chat-box" class="space-y-4 overflow-y-auto max-h-96">
          <!-- Initial auto message -->
          <div class="chat-bubble text-gray-600 text-lg">
            Mas Agus Bot is ready to chat. Please wait...
          </div>
        </div>
        <div class="mt-4 flex">
          <input
            id="user-input"
            type="text"
            placeholder="Tulis pesan..."
            class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
            disabled
          />
          <button
            id="send-button"
            class="ml-2 p-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600"
            disabled
          >
            Send
          </button>
        </div>
      </div>
    </div>

    <script>
      // Function to send a message to the API
      async function sendMessageToAPI(prompt) {
        try {
          const response = await axios.post(
            "https://mas-agus-bot.vercel.app/api/google-gemini/chat",
            {
              prompt: prompt,
            }
          );

          return response.data;
        } catch (error) {
          console.error("Error sending message:", error);
          return { response: "There was an error processing your request." };
        }
      }

      // Function to append messages to the chat box
      function appendMessageToChatBox(message, isBot = false) {
        const chatBox = document.getElementById("chat-box");
        const messageClass = isBot ? "text-gray-600" : "text-blue-600";
        const messageElement = document.createElement("div");
        messageElement.classList.add("chat-bubble");
        messageElement.classList.add(isBot ? "bg-gray-200" : "bg-blue-100");
        messageElement.classList.add(messageClass);
        messageElement.textContent = message;
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
      }

      // Function to handle user input and interaction
      function handleUserInput() {
        const userInput = document.getElementById("user-input");
        const sendButton = document.getElementById("send-button");

        const userMessage = userInput.value.trim();
        if (userMessage) {
          appendMessageToChatBox(userMessage); // Append user message
          userInput.value = ""; // Clear input box

          appendLoadingSpinner(); // Show loading spinner for bot response
          sendMessageToAPI(userMessage).then((data) => {
            // Hide the loading spinner and show bot's response
            removeLoadingSpinner();
            appendMessageToChatBox(data.response, true);
          });
        }
      }

      // Function to show loading spinner while waiting for response
      function appendLoadingSpinner() {
        const chatBox = document.getElementById("chat-box");
        const loadingElement = document.createElement("div");
        loadingElement.classList.add(
          "flex",
          "items-center",
          "justify-center",
          "space-x-2"
        );
        loadingElement.innerHTML = `
                <div class="loading-spinner"></div>
                <div class="text-gray-500">Mas Agus is typing...</div>
            `;
        chatBox.appendChild(loadingElement);
        chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
      }

      // Function to remove the loading spinner
      function removeLoadingSpinner() {
        const chatBox = document.getElementById("chat-box");
        const loadingElement = chatBox.querySelector(".loading-spinner");
        if (loadingElement) {
          loadingElement.parentElement.remove();
        }
      }

      // Initialize chat with an auto-triggered system message
      window.onload = function () {
        appendLoadingSpinner(); // Show loading spinner while waiting for bot's first response

        sendMessageToAPI("").then((data) => {
          removeLoadingSpinner(); // Remove loading spinner
          appendMessageToChatBox(data.response, true);
          document.getElementById("user-input").disabled = false;
          document.getElementById("send-button").disabled = false;
        });
      };

      // Add event listener for the send button
      document
        .getElementById("send-button")
        .addEventListener("click", handleUserInput);

      // Add event listener for enter key to send message
      document
        .getElementById("user-input")
        .addEventListener("keypress", function (event) {
          if (event.key === "Enter") {
            handleUserInput();
          }
        });
    </script>
  </body>
</html>
